<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Program Structure Migration - StylusPort::Solana</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">StylusPort::Solana</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="program-structure-and-instructions"><a class="header" href="#program-structure-and-instructions">Program structure and instructions</a></h1>
<p>This chapter explains how to translate Solana's instruction-dispatch model to Stylus contracts. The transformation involves converting instruction handlers into direct methods, mapping parameter and return types to ABI-encodable forms.</p>
<h2 id="solana-program-model"><a class="header" href="#solana-program-model">Solana program model</a></h2>
<h3 id="native"><a class="header" href="#native">Native</a></h3>
<p>When not using a framework, Solana programs require manual instruction deserialization, account validation and instruction handler routing.</p>
<pre><code class="language-rust">#[derive(BorshSerialize, BorshDeserialize)]
pub struct CounterState {
    pub value: u64,
    pub authority: Pubkey,
}

#[derive(BorshSerialize, BorshDeserialize)]
pub enum Instruction {
    Initialize { value: u64 },
    Increment,
    SetValue { new_value: u64 },
}

pub fn process_instruction(
    program_id: &amp;Pubkey,
    accounts: &amp;[AccountInfo],
    instruction_data: &amp;[u8],
) -&gt; ProgramResult {
    if !check_id(program_id) {
        return Err(ProgramError::IncorrectProgramId);
    }

    let Ok(ix) = Instruction::try_from_slice(instruction_data) else {
        return Err(ProgramError::InvalidInstructionData);
    };

    match ix {
        Instruction::Initialize { value } =&gt; process_initialize(accounts, value),
        Instruction::Increment =&gt; process_increment(accounts),
        Instruction::SetValue { new_value } =&gt; process_set_value(accounts, new_value),
    }
}

fn process_initialize(accounts: &amp;[AccountInfo], initial_value: u64) -&gt; ProgramResult {
    let [counter_state_pda, authority, system_program] = accounts else {
        return Err(ProgramError::InvalidAccountData);
    };

    // Validate accounts, create PDA account &amp; write initial state...

    Ok(())
}

fn process_increment(accounts: &amp;[AccountInfo]) -&gt; ProgramResult {
    let [counter_state_pda] = accounts else {
        return Err(ProgramError::InvalidAccountData);
    };

    // Validate accounts &amp; write incremented value...

    Ok(())
}

fn process_set_value(accounts: &amp;[AccountInfo], new_value: u64) -&gt; ProgramResult {
    let [counter_state_pda, authority] = accounts else {
        return Err(ProgramError::InvalidAccountData);
    };

    // Validate accounts &amp; write new value...

    Ok(())
}</code></pre>
<h3 id="anchor"><a class="header" href="#anchor">Anchor</a></h3>
<p>The Anchor framework abstracts the boilerplate for deserializing instruction data and function routing behind a combination of derive and procedural macros.</p>
<p>Some business logic, such as access control, developers can encode declaratively using attributes within the <code>#[derive(Accounts)]</code> macro.</p>
<pre><code class="language-rust">use anchor_lang::prelude::*;

#[program]
pub mod counter {
    use super::*;
    
    pub fn initialize(ctx: Context&lt;Initialize&gt;, value: u64) -&gt; Result&lt;()&gt; {
        let counter = &amp;mut ctx.accounts.counter;
        counter.value = value;
        counter.authority = ctx.accounts.authority.key();
        Ok(())
    }
    
    pub fn increment(ctx: Context&lt;Increment&gt;) -&gt; Result&lt;()&gt; {
        let counter = &amp;mut ctx.accounts.counter;
        counter.value += 1;
        Ok(())
    }
    
    pub fn set_value(ctx: Context&lt;SetValue&gt;, new_value: u64) -&gt; Result&lt;()&gt; {
        let counter = &amp;mut ctx.accounts.counter;
        counter.value = new_value;
        Ok(())
    }
}

#[derive(Accounts)]
pub struct Initialize&lt;'info&gt; {
    #[account(init_if_needed, payer = authority, space = 8 + 8 + 32)]
    pub counter: Account&lt;'info, Counter&gt;,
    #[account(mut)]
    pub authority: Signer&lt;'info&gt;,
    pub system_program: Program&lt;'info, System&gt;,
}

#[derive(Accounts)]
pub struct Increment&lt;'info&gt; {
    #[account(mut)]
    pub counter: Account&lt;'info, Counter&gt;,
}

#[derive(Accounts)]
pub struct SetValue&lt;'info&gt; {
    // Adds the constraint that the `authority` field in the `Counter` account
    // must match the `authority` key within this struct.
    #[account(mut, has_one = authority)]
    pub counter: Account&lt;'info, Counter&gt;,
    pub authority: Signer&lt;'info&gt;,
}

#[account]
pub struct Counter {
    pub value: u64,
    pub authority: Pubkey,
}</code></pre>
<h2 id="stylus-contract-model"><a class="header" href="#stylus-contract-model">Stylus contract model</a></h2>
<p>Stylus uses macros to abstract the boilerplate of decoding calldata and handler function selection.</p>
<p>Unlike Solana, state storage couples to business logic and the contract manages it solely. Functions that change the contract state must take <code>&amp;mut self</code>. Developers conventionally add read-only <code>view</code> functions to access contract state that clients may require. These cost no gas for external callers. Any function that takes <code>&amp;self</code> in a development block tagged with <code>#[public]</code> appears as an externally viewable <code>view</code> function.</p>
<p>The developer can create contracts with some initial state by using the <code>#[constructor]</code> attribute macro to mark the initialization function. This function runs automatically as part of the contract creation flow.</p>
<pre><code class="language-rust">sol! {
    #[derive(Debug, PartialEq, Eq)]
    error Unauthorized(address caller);
}

#[derive(SolidityError, Debug, PartialEq, Eq)]
pub enum CounterError {
    Unauthorized(Unauthorized),
}

#[storage]
#[entrypoint]
pub struct Counter {
    value: StorageU256,
    authority: StorageAddress,
}

#[public]
impl Counter {
    #[constructor]
    pub fn constructor(&amp;mut self, initial_value: U256) {
        let authority = self.vm().msg_sender();

        self.value.set(initial_value);
        self.authority.set(authority);
    }

    pub fn increment(&amp;mut self) -&gt; U256 {
        let new_value = self.value.get() + U256::ONE;

        self.value.set(new_value);

        new_value
    }

    pub fn set_value(&amp;mut self, new_value: U256) -&gt; Result&lt;(), CounterError&gt; {
        let caller = self.vm().msg_sender();

        // Only authority can set value
        if caller != self.authority.get() {
            return Err(CounterError::Unauthorized(Unauthorized { caller }));
        }

        self.value.set(new_value);

        Ok(())
    }

    // View functions
    pub fn get_value(&amp;self) -&gt; U256 {
        self.value.get()
    }

    pub fn get_authority(&amp;self) -&gt; Address {
        self.authority.get()
    }
}</code></pre>
<h2 id="key-transformation-entry-points"><a class="header" href="#key-transformation-entry-points">Key transformation: Entry points</a></h2>
<h3 id="coming-from-native-solana"><a class="header" href="#coming-from-native-solana">Coming from native Solana</a></h3>
<p>A 1-to-1 mapping exists between instruction <code>enum</code> variants and Stylus' <code>#[public]</code> functions that can change state (that take <code>&amp;mut self</code>).</p>
<p>Any fields associated with the instruction <code>enum</code> variants convert to ABI-encodable function parameters.</p>
<h3 id="coming-from-anchor"><a class="header" href="#coming-from-anchor">Coming from Anchor</a></h3>
<p>Each <code>#[program]</code> function that takes a different <code>Context&lt;T&gt;</code> maps to a <code>#[public] &amp;mut self</code> function in Stylus. Any parameters coming after <code>ctx</code> are also required.</p>
<h3 id="stylus-idioms"><a class="header" href="#stylus-idioms">Stylus idioms</a></h3>
<h4 id="function-return-types"><a class="header" href="#function-return-types">Function return types</a></h4>
<p>In both Native and Anchor-based Solana programs, most instruction handlers return a <code>Result&lt;(), ProgramError&gt;</code>, meaning no return data exists when no errors occur.</p>
<p>Stylus operates within the EVM ecosystem where successful function results commonly continue into further computation. This provides much more flexibility when it comes to return types.</p>
<p>Functions may return nothing at all, an infallible result (that just <code>T</code>) or a <code>Result&lt;T, E&gt;</code> where <code>E</code> supports <code>SolidityError</code> and <code>T</code> supports <a href="https://docs.rs/stylus-sdk/latest/stylus_sdk/abi/trait.AbiType.html"><code>AbiType</code></a>. The programmer decides the best approach.</p>
<p>View or pure computation functions typically return infallible results and functions that change state according to some business logic typically return a <code>Result</code> type.</p>
<p>The <a href="./errors-events.html">Errors and Events</a> section covers error type definition in more detail.</p>
<h4 id="contract-state-initialization"><a class="header" href="#contract-state-initialization">Contract state initialization</a></h4>
<p>In Solana programs, initialization appears as just another instruction or series of instructions, but where care must protect unauthorized use.</p>
<p>Stylus, like Solidity contracts, provides a specialized <code>constructor</code> function that runs during contract creation with parameters provided by the contract deployer. Developers commonly use this pattern to provide initial values such as initial authorized addresses and other contract state as parameters to this function.</p>
<h4 id="parameter-types"><a class="header" href="#parameter-types">Parameter types</a></h4>
<p>The constraint on parameter types in Stylus contracts requires that they support <a href="https://docs.rs/stylus-sdk/latest/stylus_sdk/abi/trait.AbiType.html"><code>AbiType</code></a>. This trait parallels the <code>BorshDeserialize</code> and <code>BorshSerialize</code> traits in Solana programs. All primitive types and tuples of primitive types already support this trait.</p>
<p>The Stylus contract programmer can define more complex types such as <code>enums</code> and <code>structs</code> using the <a href="https://docs.rs/alloy-sol-macro/0.8.20/alloy_sol_macro/macro.sol.html"><code>sol!</code> macro</a>. Those patterns fall outside the scope of this guide.</p>
<h2 id="next-steps"><a class="header" href="#next-steps">Next steps</a></h2>
<p>Now that you understand program structure transformation, explore:</p>
<ul>
<li><a href="./state-storage.html">State Storage</a> - Converting account-based storage to contract storage</li>
<li><a href="./access-control.html">Access Control</a> - Building ownership and permissions</li>
<li><a href="./external-calls.html">External Calls</a> - Making cross-contract calls</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="introduction.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="state-storage.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="introduction.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="state-storage.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
